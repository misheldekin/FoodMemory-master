@page "/edit-recipe/{RecipeId:int}"
@using Models
@using DBL
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject ProtectedSessionStorage Session
@inject NavigationManager Nav

<div class="edit-recipe-container" dir="rtl">
    <h2>✏️ עריכת מתכון</h2>

    @if (recipe == null)
    {
        <p class="loading">טוען מתכון...</p>
    }
    else
    {
        <div class="form-card">
            <!-- שם המתכון -->
            <div class="form-group">
                <label>שם המתכון</label>
                <input type="text" class="form-input" @bind="recipe.Name" placeholder="שם המתכון" />
            </div>

            <!-- שלבי ההכנה -->
            <div class="form-group">
                <label>שלבי הכנה</label>
                <textarea class="form-textarea" @bind="recipe.RecipeInstructions" rows="6" placeholder="תאר את שלבי ההכנה..."></textarea>
            </div>

            <!-- הסיפור -->
            <div class="form-group">
                <label>הסיפור מאחורי המתכון</label>
                <textarea class="form-textarea" @bind="recipe.Story" rows="4" placeholder="ספר את הסיפור..."></textarea>
            </div>

            <!-- URL תמונה -->
            <div class="form-group">
                <label>קישור לתמונה</label>
                <input type="text" class="form-input" @bind="recipe.ImageURL" placeholder="https://..." />
            </div>

            <!-- רכיבים קיימים -->
            <div class="ingredients-section">
                <h3>🥗 רכיבים</h3>

                @if (recipeIngredients != null && recipeIngredients.Count > 0)
                {
                    @for (int i = 0; i < recipeIngredients.Count; i++)
                    {
                        int index = i;
                        <div class="ingredient-item">
                            <span class="ingredient-name">@GetIngredientName(recipeIngredients[index].IngredientID)</span>
                            <input type="number" class="quantity-input" @bind="recipeIngredients[index].Quantity" step="0.1" />
                            <input type="text" class="size-input" @bind="recipeIngredients[index].Size" placeholder="יחידה" />
                        </div>
                    }
                }

                <!-- הוספת רכיב קיים -->
                <div class="add-ingredient-section">
                    <h4>➕ הוסף רכיב קיים</h4>
                    <div class="add-ingredient-form">
                        <select class="form-select" @bind="selectedIngredientId">
                            <option value="0">בחר רכיב...</option>
                            @if (allIngredients != null)
                            {
                                @for (int i = 0; i < allIngredients.Count; i++)
                                {
                                    <option value="@allIngredients[i].IngredientID">@allIngredients[i].IngredientName</option>
                                }
                            }
                        </select>
                        <input type="number" class="quantity-input" @bind="newQuantity" placeholder="כמות" step="0.1" />
                        <input type="text" class="size-input" @bind="newSize" placeholder="יחידה" />
                        <button class="add-btn" @onclick="AddExistingIngredient">הוסף</button>
                    </div>
                </div>

                <!-- הוספת רכיב חדש -->
                <div class="add-ingredient-section">
                    <h4>✨ הוסף רכיב חדש למערכת</h4>
                    <div class="add-ingredient-form">
                        <input type="text" class="form-input" @bind="newIngredientName" placeholder="שם הרכיב החדש" />
                        <input type="number" class="quantity-input" @bind="newQuantity" placeholder="כמות" step="0.1" />
                        <input type="text" class="size-input" @bind="newSize" placeholder="יחידה" />
                        <button class="add-btn" @onclick="AddNewIngredient">צור והוסף</button>
                    </div>
                </div>
            </div>

            <!-- כפתורי שמירה וביטול -->
            <div class="action-buttons">
                <button class="btn-save" @onclick="SaveChanges">💾 שמור שינויים</button>
                <button class="btn-cancel" @onclick="Cancel">❌ ביטול</button>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-message">@errorMessage</div>
            }
        </div>
    }
</div>

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap');

    * {
        font-family: 'Rubik', 'Assistant', sans-serif;
    }

    .edit-recipe-container {
        max-width: 900px;
        margin: 40px auto;
        padding: 20px;
        direction: rtl;
    }

    h2 {
        text-align: center;
        color: #414833;
        font-size: 2.5rem;
        margin-bottom: 30px;
    }

    .loading {
        text-align: center;
        color: #737A5D;
        font-size: 1.2rem;
    }

    .form-card {
        background: rgba(235, 227, 210, 0.95);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 15px 40px rgba(65, 72, 51, 0.15);
        border: 2px solid rgba(164, 172, 134, 0.3);
    }

    .form-group {
        margin-bottom: 25px;
    }

    label {
        display: block;
        color: #414833;
        font-weight: 600;
        margin-bottom: 10px;
        font-size: 1.1rem;
    }

    .form-input, .form-textarea, .form-select {
        width: 100%;
        padding: 12px 18px;
        border: 2px solid #A4AC86;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
        direction: rtl;
    }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #737A5D;
            box-shadow: 0 0 0 4px rgba(115, 122, 93, 0.2);
        }

    .form-textarea {
        resize: vertical;
        min-height: 100px;
    }

    .ingredients-section {
        margin: 30px 0;
        padding: 25px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 15px;
    }

        .ingredients-section h3 {
            color: #414833;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

    .ingredient-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        background: white;
        border-radius: 10px;
        margin-bottom: 10px;
        border: 1px solid #EBE3D2;
    }

    .ingredient-name {
        flex: 1;
        color: #414833;
        font-weight: 500;
    }

    .quantity-input {
        width: 100px;
        padding: 8px;
        border: 2px solid #A4AC86;
        border-radius: 8px;
        text-align: center;
    }

    .size-input {
        width: 120px;
        padding: 8px;
        border: 2px solid #A4AC86;
        border-radius: 8px;
        text-align: right;
    }

    .delete-btn {
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .delete-btn:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

    .add-ingredient-section {
        margin-top: 25px;
        padding: 20px;
        background: rgba(164, 172, 134, 0.1);
        border-radius: 12px;
    }

        .add-ingredient-section h4 {
            color: #414833;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

    .add-ingredient-form {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .form-select {
        flex: 1;
        min-width: 200px;
    }

    .add-btn {
        background: linear-gradient(135deg, #737A5D 0%, #414833 100%);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 10px 20px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
    }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(65, 72, 51, 0.3);
        }

    .action-buttons {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        justify-content: center;
    }

    .btn-save, .btn-cancel {
        padding: 15px 40px;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-save {
        background: linear-gradient(135deg, #737A5D 0%, #414833 100%);
        color: white;
        box-shadow: 0 6px 18px rgba(65, 72, 51, 0.35);
    }

        .btn-save:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(65, 72, 51, 0.45);
        }

    .btn-cancel {
        background: #e0e0e0;
        color: #555;
    }

        .btn-cancel:hover {
            background: #d0d0d0;
        }

    .error-message {
        margin-top: 20px;
        padding: 15px;
        background: #ffe6e6;
        border: 2px solid #ff4444;
        border-radius: 10px;
        color: #cc0000;
        text-align: center;
        font-weight: 500;
    }
</style>

@code {
    [Parameter]
    public int RecipeId { get; set; }

    Recipes recipe;
    List<RecipeIngredient> recipeIngredients;
    List<Ingredient> allIngredients;
    Dictionary<int, string> ingredientNames = new Dictionary<int, string>();

    int selectedIngredientId = 0;
    string newIngredientName = "";
    double newQuantity = 0;
    string newSize = "";
    string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        ProtectedBrowserStorageResult<int> userIdResult = await Session.GetAsync<int>("customerid");
        if (!userIdResult.Success)
        {
            Nav.NavigateTo("/login");
            return;
        }

        RecipeDB recipeDB = new RecipeDB();
        recipe = await recipeDB.SelectByPkAsync(RecipeId);

        if (recipe == null || recipe.UserID != userIdResult.Value)
        {
            Nav.NavigateTo("/MyRecipes");
            return;
        }

        RecipeIngredientDB riDB = new RecipeIngredientDB();
        recipeIngredients = await riDB.GetByRecipeAsync(RecipeId);

        IngredientDB ingredientDB = new IngredientDB();
        allIngredients = await ingredientDB.GetAllAsync();

        for (int i = 0; i < allIngredients.Count; i++)
        {
            ingredientNames[allIngredients[i].IngredientID] = allIngredients[i].IngredientName;
        }
    }

    string GetIngredientName(int ingredientId)
    {
        if (ingredientNames.ContainsKey(ingredientId))
            return ingredientNames[ingredientId];
        return "לא ידוע";
    }


    async Task AddExistingIngredient()
    {
        if (selectedIngredientId == 0)
        {
            errorMessage = "נא לבחור רכיב";
            return;
        }

        RecipeIngredient ri = new RecipeIngredient
        {
            RecipeID = RecipeId,
            IngredientID = selectedIngredientId,
            Quantity = newQuantity,
            Size = newSize
        };

        recipeIngredients.Add(ri);
        selectedIngredientId = 0;
        newQuantity = 0;
        newSize = "";
        errorMessage = "";
    }

    async Task AddNewIngredient()
    {
        if (string.IsNullOrWhiteSpace(newIngredientName))
        {
            errorMessage = "נא להזין שם רכיב";
            return;
        }

        IngredientDB ingredientDB = new IngredientDB();
        Ingredient newIng = new Ingredient { IngredientName = newIngredientName };
        Ingredient inserted = await ingredientDB.InsertGetObjAsync(newIng);

        if (inserted != null)
        {
            allIngredients.Add(inserted);
            ingredientNames[inserted.IngredientID] = inserted.IngredientName;

            RecipeIngredient ri = new RecipeIngredient
            {
                RecipeID = RecipeId,
                IngredientID = inserted.IngredientID,
                Quantity = newQuantity,
                Size = newSize
            };

            recipeIngredients.Add(ri);
            newIngredientName = "";
            newQuantity = 0;
            newSize = "";
            errorMessage = "";
        }
    }

    async Task SaveChanges()
    {
        RecipeDB recipeDB = new RecipeDB();
        int result = await recipeDB.UpdateAsync(recipe);

        if (result > 0)
        {
            RecipeIngredientDB riDB = new RecipeIngredientDB();

            for (int i = 0; i < recipeIngredients.Count; i++)
            {
                await riDB.InsertAsync(recipeIngredients[i]);
            }

            Nav.NavigateTo("/MyRecipes");
        }
        else
        {
            errorMessage = "שגיאה בשמירת המתכון";
        }
    }

    void Cancel()
    {
        Nav.NavigateTo("/MyRecipes");
    }
}