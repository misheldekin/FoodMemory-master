@page "/edit-recipe/{RecipeId:int}"
@using Models
@using DBL
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Microsoft.AspNetCore.Components.Forms
@inject ProtectedSessionStorage Session
@inject NavigationManager Nav

<div class="edit-recipe-container" dir="rtl">
    <h2>✏️ עריכת מתכון</h2>

    @if (recipe == null)
    {
        <p class="loading">טוען מתכון...</p>
    }
    else
    {
        <div class="form-card">
            <div class="form-group">
                <label>שם המתכון</label>
                <input type="text" class="form-input" @bind="recipe.Name" placeholder="שם המתכון" />
            </div>

            <div class="form-group">
                <label>שלבי הכנה</label>
                <textarea class="form-textarea" @bind="recipe.RecipeInstructions" rows="6" placeholder="תאר את שלבי ההכנה..."></textarea>
            </div>

            <div class="form-group">
                <label>הסיפור מאחורי המתכון</label>
                <textarea class="form-textarea" @bind="recipe.Story" rows="4" placeholder="ספר את הסיפור..."></textarea>
            </div>

            <div class="form-group">
                <label>תמונה</label>
                <InputFile OnChange="HandleImageUpload" accept="image/*" class="file-input" />
                @if (!string.IsNullOrEmpty(recipe.ImageURL))
                {
                    <div class="image-preview">
                        <img src="@recipe.ImageURL" alt="תמונת המתכון" />
                    </div>
                }
            </div>

            <div class="ingredients-section">
                <h3>🥗 רכיבים</h3>

                @if (recipeIngredients != null && recipeIngredients.Count > 0)
                {
                    @for (int i = 0; i < recipeIngredients.Count; i++)
                    {
                        int index = i;
                        <div class="ingredient-item">
                            <span class="ingredient-name">@GetIngredientName(recipeIngredients[index].IngredientID)</span>
                            <input type="text" class="quantity-input" @bind="recipeIngredients[index].Quantity" step="0.1" />
                            <input type="text" class="size-input" @bind="recipeIngredients[index].Size" placeholder="יחידה" />
                            <button class="delete-btn" @onclick="() => RemoveFromList(index)">🗑️</button>
                        </div>
                    }
                }

                <div class="add-ingredient-section">
                    <h4>➕ הוסף רכיב קיים</h4>
                    <div class="add-ingredient-form">
                        <select class="form-select" @bind="selectedIngredientId">
                            <option value="0">בחר רכיב...</option>
                            @if (allIngredients != null)
                            {
                                @for (int i = 0; i < allIngredients.Count; i++)
                                {
                                    <option value="@allIngredients[i].IngredientID">@allIngredients[i].IngredientName</option>
                                }
                            }
                        </select>
                        <input type="text" class="quantity-input" @bind="newQuantity" placeholder="כמות" step="0.1" />
                        <input type="text" class="size-input" @bind="newSize" placeholder="יחידה" />
                        <button class="add-btn" @onclick="AddExistingIngredient">הוסף</button>
                    </div>
                </div>

                <div class="add-ingredient-section">
                    <h4>✨ הוסף רכיב חדש למערכת</h4>
                    <div class="add-ingredient-form">
                        <input type="text" class="form-input" @bind="newIngredientName" placeholder="שם הרכיב החדש" />
                        <input type="text" class="quantity-input" @bind="newQuantity" placeholder="כמות" step="0.1" />
                        <input type="text" class="size-input" @bind="newSize" placeholder="יחידה" />
                        <button class="add-btn" @onclick="AddNewIngredient">צור והוסף</button>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn-save" @onclick="SaveChanges">💾 שמור שינויים</button>
                <button class="btn-cancel" @onclick="Cancel">❌ ביטול</button>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-message">@errorMessage</div>
            }
        </div>
    }
</div>

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap');

    * {
        font-family: 'Rubik', 'Assistant', sans-serif;
    }

    .edit-recipe-container {
        max-width: 900px;
        margin: 40px auto;
        padding: 20px;
        direction: rtl;
    }

    h2 {
        text-align: center;
        color: #414833;
        font-size: 2.5rem;
        margin-bottom: 30px;
    }

    .loading {
        text-align: center;
        color: #737A5D;
        font-size: 1.2rem;
    }

    .form-card {
        background: rgba(235, 227, 210, 0.95);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 15px 40px rgba(65, 72, 51, 0.15);
        border: 2px solid rgba(164, 172, 134, 0.3);
    }

    .form-group {
        margin-bottom: 25px;
    }

    label {
        display: block;
        color: #414833;
        font-weight: 600;
        margin-bottom: 10px;
        font-size: 1.1rem;
    }

    .form-input, .form-textarea, .form-select {
        width: 100%;
        padding: 12px 18px;
        border: 2px solid #A4AC86;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
        direction: rtl;
    }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #737A5D;
            box-shadow: 0 0 0 4px rgba(115, 122, 93, 0.2);
        }

    .form-textarea {
        resize: vertical;
        min-height: 100px;
    }

    .file-input {
        display: block;
        width: 100%;
        padding: 10px;
        background: white;
        border: 2px dashed #A4AC86;
        border-radius: 12px;
        cursor: pointer;
        margin-bottom: 15px;
    }

    .image-preview {
        margin-top: 15px;
        text-align: center;
        padding: 15px;
        background: white;
        border-radius: 12px;
    }

        .image-preview img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

    .ingredients-section {
        margin: 30px 0;
        padding: 25px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 15px;
    }

        .ingredients-section h3 {
            color: #414833;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

    .ingredient-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        background: white;
        border-radius: 10px;
        margin-bottom: 10px;
        border: 1px solid #EBE3D2;
    }

    .ingredient-name {
        flex: 1;
        color: #414833;
        font-weight: 500;
    }

    .quantity-input {
        width: 100px;
        padding: 8px;
        border: 2px solid #A4AC86;
        border-radius: 8px;
        text-align: center;
    }

    .size-input {
        width: 120px;
        padding: 8px;
        border: 2px solid #A4AC86;
        border-radius: 8px;
        text-align: right;
    }

    .delete-btn {
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .delete-btn:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

    .add-ingredient-section {
        margin-top: 25px;
        padding: 20px;
        background: rgba(164, 172, 134, 0.1);
        border-radius: 12px;
    }

    .add-ingredient-form {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .add-btn {
        background: linear-gradient(135deg, #737A5D 0%, #414833 100%);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 10px 20px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
    }

    .btn-save {
        background: linear-gradient(135deg, #737A5D 0%, #414833 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
    }

    .btn-cancel {
        background: #e0e0e0;
        color: #555;
        border: none;
        padding: 15px 40px;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        margin-right: 10px;
    }

    .error-message {
        margin-top: 20px;
        padding: 15px;
        background: #ffe6e6;
        border: 2px solid #ff4444;
        border-radius: 10px;
        color: #cc0000;
        text-align: center;
    }
</style>

@code {
    [Parameter]
    public int RecipeId { get; set; }

    Recipes recipe;
    List<RecipeIngredient> recipeIngredients;
    List<Ingredient> allIngredients;
    Dictionary<int, string> ingredientNames = new Dictionary<int, string>();

    int selectedIngredientId = 0;
    string newIngredientName = "";
    decimal newQuantity = 0;
    string newSize = "";
    string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        ProtectedBrowserStorageResult<int> userIdResult = await Session.GetAsync<int>("customerid");
        if (!userIdResult.Success)
        {
            Nav.NavigateTo("/login");
            return;
        }

        RecipeDB recipeDB = new RecipeDB();
        recipe = await recipeDB.SelectByPkAsync(RecipeId);

        if (recipe == null || recipe.UserID != userIdResult.Value)
        {
            Nav.NavigateTo("/MyRecipes");
            return;
        }

        RecipeIngredientDB riDB = new RecipeIngredientDB();
        recipeIngredients = await riDB.GetByRecipeAsync(RecipeId);

        IngredientDB ingredientDB = new IngredientDB();
        allIngredients = await ingredientDB.GetAllAsync();

        for (int i = 0; i < allIngredients.Count; i++)
        {
            ingredientNames[allIngredients[i].IngredientID] = allIngredients[i].IngredientName;
        }
    }

    string GetIngredientName(int ingredientId)
    {
        if (ingredientNames.ContainsKey(ingredientId))
            return ingredientNames[ingredientId];
        return "לא ידוע";
    }

    async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        try
        {
            IBrowserFile file = e.File;
            long maxFileSize = 5 * 1024 * 1024;
            using System.IO.Stream stream = file.OpenReadStream(maxFileSize);
            using System.IO.MemoryStream ms = new System.IO.MemoryStream();
            await stream.CopyToAsync(ms);
            byte[] buffer = ms.ToArray();
            recipe.ImageURL = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
        }
        catch (Exception ex) { errorMessage = ex.Message; }
    }

    void RemoveFromList(int index) { recipeIngredients.RemoveAt(index); }

    async Task AddExistingIngredient()
    {
        if (selectedIngredientId == 0) return;
        RecipeIngredient ri = new RecipeIngredient { RecipeID = RecipeId, IngredientID = selectedIngredientId, Quantity = newQuantity, Size = newSize };
        recipeIngredients.Add(ri);
        selectedIngredientId = 0; newQuantity = 0; newSize = "";
    }

    async Task AddNewIngredient()
    {
        if (string.IsNullOrWhiteSpace(newIngredientName)) return;
        IngredientDB ingredientDB = new IngredientDB();
        Ingredient inserted = await ingredientDB.InsertGetObjAsync(new Ingredient { IngredientName = newIngredientName });
        if (inserted != null)
        {
            allIngredients.Add(inserted);
            ingredientNames[inserted.IngredientID] = inserted.IngredientName;
            recipeIngredients.Add(new RecipeIngredient { RecipeID = RecipeId, IngredientID = inserted.IngredientID, Quantity = newQuantity, Size = newSize });
            newIngredientName = ""; newQuantity = 0; newSize = "";
        }
    }

    async Task SaveChanges()
    {
        try
        {
            RecipeDB recipeDB = new RecipeDB();
            int result = await recipeDB.UpdateAsync(recipe);
            if (result > 0)
            {
                RecipeIngredientDB riDB = new RecipeIngredientDB();
                await riDB.DeleteByRecipeAsync(RecipeId);
                for (int i = 0; i < recipeIngredients.Count; i++)
                {
                    recipeIngredients[i].RecipeID = RecipeId;
                    await riDB.InsertAsync(recipeIngredients[i]);
                }
                Nav.NavigateTo("/MyRecipes");
            }
        }
        catch (Exception ex) { errorMessage = ex.Message; }
    }

    void Cancel() => Nav.NavigateTo("/MyRecipes");
}