@page "/RateChef/{OrderId:int}"
@using Models
@using DBL
@inject NavigationManager Nav

<div class="rating-container" dir="rtl">

    <button class="back-btn" @onclick="GoBack">חזרה להזמנות</button>

    @if (isLoading)
    {
        <p>טוען...</p>
    }
    else if (order == null)
    {
        <p class="error-text">לא ניתן לדרג הזמנה זו</p>
    }
    else if (order.IsRated)
    {
        <p class="status-msg">כבר דירגת את השף עבור הזמנה זו ✅</p>
    }
    else
    {
        <h2>דרג את השף: @order.ChefName</h2>

        <div class="stars">

            @for (int i = 1; i <= 5; i++)
            {
                int value = i;

                <span class="star @(value <= selectedScore ? "filled" : "")"
                      @onclick="() => SelectScore(value)">
                    ★
                </span>
            }

        </div>

        <button class="btn-submit"
                @onclick="SubmitRating"
                disabled="@(selectedScore == 0)">
            שלח דירוג
        </button>

        <p class="status-msg">@message</p>
    }

</div>

<style>
    .rating-container {
        max-width: 500px;
        margin: 50px auto;
        text-align: center;
    }

    .star {
        font-size: 2.5rem;
        cursor: pointer;
        color: #ccc;
    }

        .star.filled {
            color: #f39c12;
        }

    .btn-submit {
        background: #e67e22;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
    }

    .status-msg {
        margin-top: 15px;
        font-weight: bold;
        color: green;
    }

    .error-text {
        color: red;
    }
</style>

@code {

    [Parameter]
    public int OrderId { get; set; }

    private Order order;
    private bool isLoading = true;
    private int selectedScore = 0;
    private string message = "";

    protected override async Task OnInitializedAsync()
    {
        OrderDB orderDB = new OrderDB();
        order = await orderDB.SelectByPkAsync(OrderId);

        if (order != null)
        {
            if (order.Status != "Completed")
            {
                order = null;
            }
            else
            {
                ChefDB chefDB = new ChefDB();
                Chef chef = await chefDB.SelectByPkAsync(order.ChefID);

                order.ChefName =
                    chef != null
                    ? chef.FirstName + " " + chef.LastName
                    : "לא נמצא";
            }
        }

        isLoading = false;
    }

    void SelectScore(int score)
    {
        selectedScore = score;
    }

    async Task SubmitRating()
    {
        ChefDB chefDB = new ChefDB();
        OrderDB orderDB = new OrderDB();

        int result =
            await chefDB.UpdateRatingAsync(order.ChefID, selectedScore);

        if (result > 0)
        {
            await orderDB.MarkAsRatedAsync(OrderId);

            message = "הדירוג נשמר בהצלחה!";

            await Task.Delay(1500);

            Nav.NavigateTo("/MyOrders");
        }
        else
        {
            message = "שגיאה בשמירת הדירוג";
        }
    }

    void GoBack()
    {
        Nav.NavigateTo("/MyOrders");
    }
}